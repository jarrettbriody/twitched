<!DOCTYPE html>
<html>
  <head>
    <title>Twitched</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      
    </style>
  </head>
  <body>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
      $(document).ready(function() {
        if(chrome.runtime.lastError) chrome.runtime.lastError = null;

        var baseUrl = "https://twitchedapp.herokuapp.com";
        
        $("#userNameForm").submit(function(e){
          var action = $("#userNameForm").attr("action");
          var name = "name=" + encodeURIComponent($("#userName").val());
          name = name.toLowerCase();
          //console.log("HELLOOOOO: " + baseUrl + action + name);
          $.ajax({
            cache: false,
            type: "get",
            url: baseUrl + action,
            data: name,
            dataType: "json",
            success: function (result, status, xhr) {
              var resultText = JSON.stringify(result);
              $("#result").text(resultText);
              var json = JSON.parse(result);
              
              var newImg = document.createElement("img");
              newImg.src = json.users[0].logo;
              document.querySelector("#result").appendChild(newImg);

              if(document.querySelector("#showStream").value != "on"){
                var embed = new Twitch.Embed("twitch-embed", {
                    width: 854,
                    height: 480,
                    channel: json.users[0].display_name
                });
              }
              else {
                var embedDiv = document.querySelector("#twitch-embed");
                var chatIFrame = document.createElement("iframe");
                chatIFrame.frameBorder = 0;
                chatIFrame.scrolling = "yes";
                chatIFrame.id = json.users[0].display_name;
                chatIFrame.src = "https://www.twitch.tv/embed/" + json.users[0].display_name + "/chat";
                chatIFrame.height = 500;
                chatIFrame.width = 350;
                embedDiv.appendChild(chatIFrame);
              }
            },
            error: function (result, status, xhr) {
              var resultText = JSON.stringify(result);
              $("#result").text(resultText);
              console.dir(result);
              //$("#result").text(result.responseJSON.error);
            }
          });
          e.preventDefault();
          return false;
        });
      });
    </script>
    <input id="showStream" type="checkbox">
    <label for="showStream">Show stream?</label>
    <form id="userNameForm" action="/user" method="get">
      <input id="userName" type="text" name="name" placeholder="Twitch Username" value = "loltyler1">
      <input type="submit" value="Generate">
    </form>
    <div id="result"></div>
    <div id="twitch-embed"></div>
  </body>
</html>