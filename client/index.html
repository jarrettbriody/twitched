<!DOCTYPE html>
<html>
  <head>
    <title>Twitched</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      .icons{
        display:none;
      }
    </style>
  </head>
  <body>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
      $(document).ready(function() {
        if(chrome.runtime.lastError) chrome.runtime.lastError = null;

        var xImgReg = document.querySelector("#xImgReg");
        var xImgHover = document.querySelector("#xImgHover");

        var baseUrl = "https://twitchedapp.herokuapp.com";

        var openedStreams = [];

        var embedDiv = document.querySelector("#twitch-embed");
        
        $("#userNameForm").submit(function(e){
          var action = $("#userNameForm").attr("action");
          var name = "name=" + encodeURIComponent($("#userName").val());
          name = name.toLowerCase();
          //console.log("HELLOOOOO: " + baseUrl + action + name);
          $.ajax({
            cache: false,
            type: "get",
            url: baseUrl + action,
            data: name,
            dataType: "json",
            success: function (result, status, xhr) {
              var resultText = JSON.stringify(result);
              var json = JSON.parse(result);
              
              /*
              $("#result").text(resultText);
              var newImg = document.createElement("img");
              newImg.src = json.users[0].logo;
              document.querySelector("#result").appendChild(newImg);
              */

              var t;

              for(var i = 0; i < openedStreams.length; i++){
                var s = openedStreams[i];
                if(s == json.users[0].display_name){
                  var someStream = document.querySelector("#" + s);
                  embedDiv.removeChild(someStream);
                  break;
                }
              }

              var newButton = document.createElement("button");
              newButton.type = "button";
              newButton.name = json.users[0].display_name;
              newButton.onmouseover = function(e){
                e.target.childNodes[0] = Object.assign({},xImgHover);
              }
              newButton.onmouseleave = function(e){
                e.target.childNodes[0] = Object.assign({},xImgReg);
              }
              newButton.onclick = function(e){
                var someStream = document.querySelector("#" + e.target.name);
                embedDiv.removeChild(someStream);
                embedDiv.removeChild(e.target);
              }
              newButton.appendChild(Object.assign({},xImgReg));
              embedDiv.appendChild(newButton);

              if(document.querySelector("#showStream").checked){
                var embedStreamDiv = document.createElement("div");
                embedStreamDiv.id = json.users[0].display_name;
                embedDiv.appendChild(embedStreamDiv);
                var embedStream = new Twitch.Embed(embedStreamDiv.id, {
                    width: 854,
                    height: 480,
                    channel: json.users[0].display_name
                });
              }
              else {
                var embedDiv = document.querySelector("#twitch-embed");
                var chatIFrame = document.createElement("iframe");
                chatIFrame.frameBorder = 0;
                chatIFrame.scrolling = "yes";
                chatIFrame.id = json.users[0].display_name;
                chatIFrame.src = "https://www.twitch.tv/embed/" + json.users[0].display_name + "/chat";
                chatIFrame.height = 500;
                chatIFrame.width = 350;
                embedDiv.appendChild(chatIFrame);
              }

              openedStreams.push(json.users[0].display_name);
            },
            error: function (result, status, xhr) {
              var resultText = JSON.stringify(result);
              $("#result").text(resultText);
              console.dir(result);
              //$("#result").text(result.responseJSON.error);
            }
          });
          e.preventDefault();
          return false;
        });
      });
    </script>
    <input id="showStream" type="checkbox">
    <label for="showStream">Show stream?</label>
    <form id="userNameForm" action="/user" method="get">
      <input id="userName" type="text" name="name" placeholder="Twitch Username" value = "sodapoppin">
      <input type="submit" value="Generate">
    </form>
    <div id="result"></div>
    <div id="twitch-embed"></div>

    <img class="icons" id="xImgReg" src="media/xImgReg.png" alt="image not found" />
    <img class="icons" id="xImgHover" src="media/xImgHover.png" alt="image not found" />
  </body>
</html>